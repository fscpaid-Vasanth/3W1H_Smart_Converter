<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>3W1H Smart Converter</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: Inter, sans-serif
    }

    .hidden {
      display: none
    }

    #aiOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .92);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      color: white
    }

    .pulse {
      animation: pulse 1.5s infinite
    }

    @keyframes pulse {
      0% {
        opacity: .4
      }

      50% {
        opacity: 1
      }

      100% {
        opacity: .4
      }
    }

    .mic-pulse {
      animation: micPulse 1s infinite
    }

    @keyframes micPulse {
      0% {
        transform: scale(1);
        opacity: .6
      }

      50% {
        transform: scale(1.15);
        opacity: 1
      }

      100% {
        transform: scale(1);
        opacity: .6
      }
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- OVERLAY -->
  <div id="aiOverlay" class="flex flex-col gap-3 text-center">
    <div class="text-3xl pulse">ü§ñ Digital Transformation in Progress</div>
    <div id="overlayText" class="text-sm text-gray-300">Processing‚Ä¶</div>
  </div>

  <!-- ===== INPUT GUIDANCE NOTE MODAL ===== -->
  <div id="guidanceModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center">
    <div class="bg-white w-[500px] rounded-xl shadow-2xl p-6 mx-4">
      <div class="text-center">
        <div class="text-5xl mb-3">üìã</div>
        <h2 class="text-xl font-bold text-blue-700 mb-3">Important: Before You Begin</h2>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
          <p class="text-sm text-gray-700 mb-3">
            <span class="font-bold text-blue-800">üìå Please refer to the sample inputs</span> at the bottom of the input
            panel for a perfect input statement format.
          </p>
          <p class="text-sm text-gray-700 mb-3">
            Your input should follow the <strong>Problem ‚Üí Root Causes ‚Üí Action Plan</strong> structure for best 3W1H
            results.
          </p>
          <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
            <p class="text-sm text-yellow-800 font-semibold">‚ö†Ô∏è Input must be in English language only.</p>
          </div>
        </div>
        <button onclick="closeGuidanceModal()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg transition text-sm">
          ‚úÖ I Understand ‚Äî Continue to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- ================= SUBSCRIPTION MODAL ================= -->
  <div id="subscriptionModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center">

    <div class="bg-white w-[750px] rounded-lg shadow-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-blue-600">üì¶ Subscription Plans</h2>
        <button onclick="closeSubscription()" class="text-xl">‚úñ</button>
      </div>

      <div class="grid grid-cols-4 gap-4">

        <!-- FREE TRIAL (Default) -->
        <div class="border-2 border-blue-400 rounded p-4 text-center bg-blue-50">
          <div class="text-xs font-bold text-blue-600 mb-1">üéÅ DEFAULT</div>
          <h3 class="font-semibold text-lg mb-1 text-blue-700">Free Trial</h3>
          <p class="text-2xl font-bold mb-1">‚Çπ0</p>
          <p class="text-xs text-gray-500 mb-3">50 Credits / 1 Month</p>
          <ul class="text-xs text-gray-600 mb-4 space-y-1">
            <li>‚úî Write Input (10 Credits)</li>
            <li>‚úî Audio Upload (20 Credits)</li>
            <li>‚úî Live Audio (30 Credits)</li>
          </ul>
          <div class="w-full bg-blue-100 text-blue-700 py-1 rounded text-sm font-semibold">
            Active by Default
          </div>
        </div>

        <!-- BASIC -->
        <div class="border rounded p-4 text-center">
          <h3 class="font-semibold text-lg mb-1">Basic</h3>
          <p class="text-2xl font-bold mb-1">‚Çπ499</p>
          <p class="text-xs text-gray-500 mb-3">500 Credits / Month</p>
          <ul class="text-xs text-gray-600 mb-4 space-y-1">
            <li>‚úî Write Input (10 Credits)</li>
            <li>‚úî Audio Upload (20 Credits)</li>
            <li>‚úî Live Audio (30 Credits)</li>
          </ul>
          <button onclick="startSubscription('plan_SGJ9lQs5QEKndd')"
            class="w-full bg-blue-600 text-white py-1 rounded text-sm">
            Subscribe
          </button>
        </div>

        <!-- PRO -->
        <div class="border-2 border-green-600 rounded p-4 text-center">
          <h3 class="font-semibold text-lg mb-1 text-green-700">Pro</h3>
          <p class="text-2xl font-bold mb-1">‚Çπ999</p>
          <p class="text-xs text-gray-500 mb-3">1200 Credits / Month</p>
          <ul class="text-xs text-gray-600 mb-4 space-y-1">
            <li>‚úî All Input Modes</li>
            <li>‚úî Priority Processing</li>
            <li>‚úî Unlimited Exports</li>
          </ul>
          <button onclick="startSubscription('plan_SGJCJCot5JdhOo')"
            class="w-full bg-green-600 text-white py-1 rounded text-sm">
            Subscribe
          </button>
        </div>

        <!-- Premium -->
        <div class="border rounded p-4 text-center">
          <h3 class="font-semibold text-lg mb-1">Premium</h3>
          <p class="text-2xl font-bold mb-1">‚Çπ1999</p>
          <p class="text-xs text-gray-500 mb-3">Unlimited Credits</p>
          <ul class="text-xs text-gray-600 mb-4 space-y-1">
            <li>‚úî Unlimited Usage</li>
            <li>‚úî Dedicated Support</li>
            <li>‚úî Custom Integrations</li>
          </ul>
          <button onclick="startSubscription('plan_SGJDEt9DtLott3')"
            class="w-full bg-purple-600 text-white py-1 rounded text-sm">
            Subscribe
          </button>
        </div>

      </div>
    </div>
  </div>
  <!-- ================= END SUBSCRIPTION MODAL ================= -->

  <header class="bg-white shadow px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold text-blue-600">3W1H Smart Converter</h1>

    <div class="flex items-center gap-3">
      <div class="bg-purple-50 px-3 py-1 rounded border text-sm">
        üë§ <span id="userEmail">Loading...</span>
      </div>
      <div class="bg-blue-50 px-3 py-1 rounded border text-sm">
        üí∞ Credits: <span id="creditBalance">5</span>
      </div>
      <button onclick="openSubscription()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-semibold">
        üì¶ Subscription
      </button>
      <button onclick="handleLogout()"
        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold">
        üö™ Logout
      </button>

    </div>

  </header>

  <main class="p-6 flex gap-6">

    <!-- LEFT PANEL -->
    <section class="bg-white w-[40%] p-4 rounded shadow">
      <h2 class="font-semibold mb-3">Input Configuration</h2>

      <div class="flex gap-6 mb-4 text-sm">
        <label><input type="radio" name="inputType" value="text" checked> Write</label>
        <label><input type="radio" name="inputType" value="audio"> Audio</label>
        <label><input type="radio" name="inputType" value="live"> Live</label>
      </div>

      <div id="textSection">
        <textarea id="textInput" rows="5" class="w-full border p-2 rounded"
          placeholder="Write root cause / incident statement..."></textarea>
      </div>

      <div id="audioSection" class="hidden">
        <input type="file" id="audioFile" accept=".wav,.mp3,.m4a,.webm" class="w-full border p-2 rounded">
      </div>

      <div id="liveSection" class="hidden border p-6 rounded bg-gradient-to-b from-gray-50 to-white">
        <div class="text-sm font-semibold mb-4 text-center text-gray-700">üéô Live Audio Recording</div>

        <!-- Large Mic Icon -->
        <div class="flex flex-col items-center mb-4">
          <div id="micIcon"
            class="w-24 h-24 rounded-full bg-red-50 border-2 border-red-200 flex items-center justify-center mb-3 transition-all duration-300">
            <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          </div>
          <div id="timer" class="text-lg font-mono font-bold text-gray-700 mb-1">00:00</div>
        </div>

        <!-- Audio Level Bar -->
        <div class="w-full bg-gray-200 h-2 rounded mb-4 overflow-hidden">
          <div id="levelBar" class="h-2 bg-red-500 w-0 transition-all"></div>
        </div>

        <!-- Start / Stop Buttons -->
        <div class="flex justify-center gap-3 mb-4">
          <button id="startRec"
            class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 text-sm rounded-lg font-semibold flex items-center gap-2 transition">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="8" />
            </svg>
            Start Recording
          </button>
          <button id="stopRec"
            class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2 text-sm rounded-lg font-semibold flex items-center gap-2 transition"
            disabled>
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <rect x="6" y="6" width="12" height="12" rx="1" />
            </svg>
            Stop Recording
          </button>
        </div>

        <!-- Tagline / Help Text -->
        <div class="text-center bg-blue-50 border border-blue-100 rounded-lg px-3 py-2">
          <p class="text-xs text-blue-600 font-medium">üí° If any error occurs, please use the mic clearly ‚Äî with or
            without a headset.</p>
          <p class="text-xs text-gray-400 mt-1">Supported: Chrome, Edge, Firefox | Speak clearly for best results</p>
        </div>
      </div>

      <button id="convertBtn" class="w-full bg-blue-600 text-white py-2 rounded mt-4 font-semibold">
        Convert to the 3W1H
      </button>

      <!-- SAMPLE INPUTS SECTION -->
      <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
        <div class="text-xs font-semibold text-gray-600 mb-2">üí° Sample Input Examples:</div>

        <div class="text-xs text-gray-500 space-y-2">
          <div class="bg-white p-2 rounded border border-gray-100">
            <div class="font-medium text-gray-700 mb-1">Cold Storage Failure:</div>
            <div class="italic">"<strong>Problem:</strong> Refrigeration unit failed from 4¬∞C to 15¬∞C on Feb 12 at 6:30
              AM. <strong>Root Causes:</strong> Compressor motor failure. <strong>Action Plan:</strong> Maintenance team
              replaced compressor in 3 hours, saving ‚Çπ2.5L dairy stock."</div>
          </div>

          <div class="bg-white p-2 rounded border border-gray-100">
            <div class="font-medium text-gray-700 mb-1">Food Safety Incident:</div>
            <div class="italic">"<strong>Problem:</strong> Fresh produce contaminated from proper storage to compromised
              on Mar 5 evening shift. <strong>Root Causes:</strong> Raw meat packaging leaked onto vegetable display.
              <strong>Action Plan:</strong> Store supervisor removed 25kg affected items, sanitized area in 45 mins."
            </div>
          </div>

          <div class="bg-white p-2 rounded border border-gray-100">
            <div class="font-medium text-gray-700 mb-1">Production Line Stoppage:</div>
            <div class="italic">"<strong>Problem:</strong> Assembly line stopped from 45 units/hour to 0 units/hour on
              Feb 8 at 2:15 PM. <strong>Root Causes:</strong> Robotic welding arm sensor malfunction. <strong>Action
                Plan:</strong> Engineering team recalibrated sensor in 90 mins, resumed production saving 68 units."
            </div>
          </div>
        </div>
      </div>
      </div>
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="bg-white w-[60%] p-6 rounded shadow">

      <div class="flex justify-between mb-3">
        <button onclick="clearOutput()" class="bg-orange-500 text-white text-xs px-3 py-1 rounded">üßπ Clear</button>

        <div class="flex gap-2">
          <button onclick="exportExcel('resultTable','First_Investigation_Report.xlsx')"
            class="bg-red-600 text-white text-xs px-3 py-1 rounded">‚¨á Export First Investigation Report</button>

          <button onclick="exportProfessional()" class="bg-green-600 text-white text-xs px-3 py-1 rounded">‚¨á Export
            Professional Investigation Analysis ( 3W1H )</button>
        </div>
      </div>

      <div id="subscriptionCard"
        class="bg-blue-50 border border-blue-200 px-4 py-3 rounded shadow-sm text-sm hidden flex justify-between items-center mb-6">
        <div>
          <div id="subPlan" class="font-bold text-blue-800"></div>
          <div id="subExpiry" class="text-xs text-gray-500 mt-0.5"></div>
        </div>
        <button onclick="openSubscription()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-semibold transition-colors">
          üöÄ Next Plan Upgrade
        </button>
      </div>




      <!-- LANGUAGE INFO DISPLAY -->
      <div id="languageInfo" class="bg-purple-50 border border-purple-200 px-3 py-2 rounded text-xs mb-4 hidden">
        <span class="font-bold text-purple-800">üåç Language:</span>
        <span id="detectedLang" class="font-semibold"></span>
        <span id="translationStatus" class="ml-2 text-purple-600"></span>
      </div>

      <div id="transcriptDisplay"
        class="bg-gray-100 border border-gray-200 px-3 py-2 rounded text-xs italic mb-4 hidden">
        <span class="font-bold not-italic">Captured Transcript:</span> <span id="transcriptText"></span>
      </div>

      <h2 class="font-semibold mb-2">First Investigation Report</h2>
      <table id="resultTable" class="w-full text-xs border mb-6">
        <thead class="bg-yellow-100">
          <tr>
            <th class="border px-2 py-1">#</th>
            <th class="border px-2 py-1">What</th>
            <th class="border px-2 py-1">From</th>
            <th class="border px-2 py-1">To</th>
            <th class="border px-2 py-1">When</th>
            <th class="border px-2 py-1">Who</th>
            <th class="border px-2 py-1">How</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>

      <h2 class="font-semibold mb-2 text-green-700">Professional Investigation Analysis ( 3W1H )</h2>
      <table id="professionalTable" class="w-full text-xs border">
        <thead class="bg-green-100">
          <tr>
            <th class="border px-2 py-1">#</th>
            <th class="border px-2 py-1">What (Problem)</th>
            <th class="border px-2 py-1">From</th>
            <th class="border px-2 py-1">To</th>
            <th class="border px-2 py-1">When</th>
            <th class="border px-2 py-1">Who</th>
            <th class="border px-2 py-1">How (Action Plan)</th>
          </tr>
        </thead>
        <tbody id="professionalBody"></tbody>
      </table>

      <!-- SUMMARY BOX -->
      <div id="summaryBox" class="hidden mt-4 border-2 border-green-600 rounded-lg p-4 bg-green-50">
        <h3 class="font-bold text-green-800 text-sm mb-2">üìã Executive Summary</h3>
        <div id="summaryContent" class="text-xs text-gray-800 leading-relaxed"></div>
      </div>

    </section>
  </main>

  <script>
    /* ===== SUBSCRIPTION ===== */
    let totalPlanCredits = 0; // Will be set from subscription data

    function openSubscription() {
      // Lock plan change until 90% of credits are consumed
      if (totalPlanCredits > 0 && !isUnlimited) {
        const usedPercent = ((totalPlanCredits - credits) / totalPlanCredits) * 100;
        if (usedPercent < 90) {
          alert(`‚ö†Ô∏è Plan change is locked until you consume 90% of your credits.\n\nCurrently used: ${usedPercent.toFixed(0)}% (${totalPlanCredits - credits} of ${totalPlanCredits} credits).\nYou need to use at least ${Math.ceil(totalPlanCredits * 0.9) - (totalPlanCredits - credits)} more credits.`);
          return;
        }
      }
      subscriptionModal.classList.remove("hidden");
    }
    function closeSubscription() { subscriptionModal.classList.add("hidden"); }

    /* ===== GUIDANCE MODAL ===== */
    function closeGuidanceModal() { document.getElementById('guidanceModal').classList.add('hidden'); }
    function showGuidanceModal() { document.getElementById('guidanceModal').classList.remove('hidden'); }


    /* ===== CREDIT ===== */
    let credits = 0;
    let isUnlimited = false;

    creditBalance.textContent = credits;

    // Deduct credits locally AND persist to backend
    async function deduct(amount) {
      if (isUnlimited) return true;
      if (credits < amount) { alert("Insufficient credits. Please upgrade your plan."); return false; }
      credits -= amount;
      creditBalance.textContent = credits;

      // Persist to Firestore via backend
      try {
        const apiBase = window.API_BASE_URL || "";
        const res = await fetch(apiBase + "/api/subscription/deduct-credits", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken },
          body: JSON.stringify({ amount })
        });
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          console.error("‚ùå Backend credit deduction failed:", errData);
          alert("Unable to process credits: " + (errData.error || "Technical error"));
          // Revert local UI if backend fails
          credits += amount;
          creditBalance.textContent = credits;
          return false;
        }
        return true;
      } catch (e) {
        console.error("Credit deduction persist failed:", e);
        alert("Network error. Please check your connection and try again.");
        credits += amount;
        creditBalance.textContent = credits;
        return false;
      }
    }

    /* ===== OVERLAY ===== */
    const show = t => { overlayText.textContent = t; aiOverlay.style.display = "flex" };
    const hide = () => aiOverlay.style.display = "none";

    /* ===== SECTION TOGGLE ===== */
    document.querySelectorAll("input[name=inputType]").forEach(r => {
      r.onchange = () => {
        textSection.classList.add("hidden");
        audioSection.classList.add("hidden");
        liveSection.classList.add("hidden");
        if (r.value === "text") textSection.classList.remove("hidden");
        if (r.value === "audio") audioSection.classList.remove("hidden");
        if (r.value === "live") liveSection.classList.remove("hidden");
      };
    });

    /* ===== RESPONSE NORMALIZER ===== */
    function extractRows(res) {
      console.log("üì• EXTRACTING ROWS FROM:", res);
      if (Array.isArray(res)) return res;
      if (Array.isArray(res?.rows)) return res.rows;
      if (Array.isArray(res?.data)) return res.data;
      if (typeof res === 'object') {
        // Try to find any array property
        for (let k in res) {
          if (Array.isArray(res[k])) return res[k];
        }
      }
      return [];
    }

    /* ===== CONVERT BUTTON ===== */
    convertBtn.onclick = async () => {
      const type = document.querySelector("input[name=inputType]:checked").value;
      if (type === "live") return;

      const cost = type === "text" ? 10 : 20;
      if (!(await deduct(cost))) return;

      show("Processing‚Ä¶");
      let data;

      try {
        const apiBase = window.API_BASE_URL || "";
        if (type === "text") {
          data = await (await fetch(apiBase + "/api/analyze/text", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken },
            body: JSON.stringify({ text: textInput.value, framework: "3W1H" })
          })).json();
        } else if (type === "audio") {
          if (!audioFile.files[0]) { alert("Select audio file"); hide(); return; }
          const fd = new FormData();
          fd.append("audio", audioFile.files[0]);
          const uploadRes = await fetch(apiBase + "/api/upload", { method: "POST", body: fd, headers: { "Authorization": "Bearer " + authToken } });
          if (!uploadRes.ok) {
            const err = await uploadRes.json();
            hide();
            alert("Upload failed: " + (err.error || "Unknown error"));
            return;
          }
          const u = await uploadRes.json();
          data = await (await fetch(apiBase + "/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken },
            body: JSON.stringify({ filePath: u.filePath, framework: "3W1H", language: "en" })
          })).json();
        }
        render(extractRows(data), data.transcript, {
          detectedLanguage: data.detectedLanguage,
          wasTranslated: data.wasTranslated,
          translatedText: data.translatedText
        });
      } catch (e) {
        console.error("Conversion failed:", e);
        alert("Conversion failed: " + e.message);
      }
      hide();
    };

    /* ===== LIVE AUDIO ===== */
    let recorder, chunks = [], stream, timerInt, startTime;

    async function getSupportedMimeType() {
      const types = ["audio/webm", "audio/mp4", "audio/ogg", "audio/wav"];
      for (const t of types) {
        if (MediaRecorder.isTypeSupported(t)) return t;
      }
      return "";
    }

    startRec.onclick = async () => {
      console.log("üé§ STARTING RECORDING...");
      if (!isUnlimited && credits < 30) { alert("Insufficient credits. 30 credits required for Live Audio."); return; }

      try {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, channelCount: 1 }
          });
        } catch (e) {
          console.warn("‚ö†Ô∏è High-quality mic constraints failed, using defaults.");
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }

        const mime = await getSupportedMimeType();
        console.log("üõ†Ô∏è SUPPORTED MIME:", mime);

        // --- Volume Monitor ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        const checkVolume = () => {
          if (!recorder || recorder.state !== "recording") return;
          analyser.getByteFrequencyData(dataArray);
          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
          const avg = sum / dataArray.length;
          console.log("üîä Current Volume Level:", avg.toFixed(2));
          if (avg < 1) console.warn("üîà WARNING: Very low volume detected! Check your mic.");
          setTimeout(checkVolume, 2000);
        };
        // ----------------------

        recorder = new MediaRecorder(stream, mime ? { mimeType: mime, audioBitsPerSecond: 128000 } : { audioBitsPerSecond: 128000 });
        chunks = [];
        recorder.ondataavailable = e => {
          if (e.data.size > 0) {
            chunks.push(e.data);
            console.log("üì¶ CHUNK RECORDED:", e.data.size);
          }
        };
        recorder.onstop = processLiveAudio;
        recorder.start();
        checkVolume();

        micIcon.classList.add("mic-pulse");
        startTime = Date.now();
        timerInt = setInterval(() => timer.textContent =
          new Date(Date.now() - startTime).toISOString().substr(14, 5), 1000);

        startRec.disabled = true;
        stopRec.disabled = false;
      } catch (err) {
        console.error("‚ùå MIC ERROR:", err);
        alert("Microphone error: " + err.message);
      }
    };

    stopRec.onclick = () => {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      clearInterval(timerInt);
      micIcon.classList.remove("mic-pulse");
      startRec.disabled = false;
      stopRec.disabled = true;
    };

    async function processLiveAudio() {
      console.log("‚èπÔ∏è RECORDING STOPPED. CHUNKS:", chunks.length);
      if (!chunks.length) { alert("No audio captured"); return; }

      const blob = new Blob(chunks, { type: chunks[0].type });
      console.log("üß¨ FINAL BLOB:", blob.size, "TYPE:", blob.type);

      if (blob.size < 1000) {
        alert("Audio recording too short or empty.");
        return;
      }

      if (!(await deduct(30))) return;
      show("Analyzing live audio‚Ä¶");

      try {
        const apiBase = window.API_BASE_URL || "";
        const fd = new FormData();
        fd.append("audio", blob, "live." + (blob.type.split("/")[1]?.split(";")[0] || "webm"));

        console.log("üì§ UPLOADING LIVE AUDIO...");
        const uploadRes = await fetch(apiBase + "/api/upload", {
          method: "POST",
          body: fd,
          headers: { "Authorization": "Bearer " + authToken }
        });
        if (!uploadRes.ok) {
          const err = await uploadRes.json();
          throw new Error(err.error || "Upload failed");
        }
        const u = await uploadRes.json();
        console.log("‚úÖ UPLOAD SUCCESS:", u.filePath);

        console.log("üîç ANALYZING 3W1H...");
        const analyzeRes = await fetch(apiBase + "/api/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + authToken
          },
          body: JSON.stringify({ filePath: u.filePath, framework: "3W1H", language: "en" })
        });
        if (!analyzeRes.ok) {
          const err = await analyzeRes.json();
          throw new Error(err.message || "Analysis failed");
        }
        const data = await analyzeRes.json();
        console.log("üìä ANALYZE RESULT:", data);
        render(extractRows(data), data.transcript, {
          detectedLanguage: data.detectedLanguage,
          wasTranslated: data.wasTranslated,
          translatedText: data.translatedText
        });
      } catch (e) {
        console.error("‚ùå LIVE AUDIO ERROR:", e);
        alert("Live audio failed: " + e.message);
      }
      hide();
    }

    /* ===== RENDER ===== */
    function render(rows, transcript, languageData) {
      // Display transcript
      if (transcript) {
        transcriptText.textContent = transcript;
        transcriptDisplay.classList.remove("hidden");
      } else {
        transcriptDisplay.classList.add("hidden");
      }

      // Display language information
      if (languageData && languageData.detectedLanguage) {
        const langNames = {
          'en': 'English',
          'kn': 'Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)',
          'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
          'ta': 'Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)',
          'te': 'Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)',
          'ml': 'Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)',
          'mr': 'Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)',
          'bn': 'Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)',
          'pa': 'Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)',
          'gu': 'Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)'
        };

        const langName = langNames[languageData.detectedLanguage] || languageData.detectedLanguage.toUpperCase();
        detectedLang.textContent = langName;

        if (languageData.wasTranslated) {
          translationStatus.textContent = '‚úÖ Translated to English for analysis';
          translationStatus.title = languageData.translatedText || '';
        } else {
          translationStatus.textContent = '';
        }

        languageInfo.classList.remove("hidden");
      } else {
        languageInfo.classList.add("hidden");
      }

      resultBody.innerHTML = "";
      professionalBody.innerHTML = "";
      if (!rows.length) {
        resultBody.innerHTML = professionalBody.innerHTML =
          `<tr><td colspan="7" class="text-center py-4">No data</td></tr>`;
        return;
      }

      // Build summary parts
      let summaryParts = [];

      rows.forEach((r, i) => {
        // First Investigation Report ‚Äî raw data
        resultBody.innerHTML += `
      <tr>
        <td class="border px-2 py-1 align-top">${i + 1}</td>
        <td class="border px-2 py-1 align-top">${r.what || ""}</td>
        <td class="border px-2 py-1 align-top">${r.from || ""}</td>
        <td class="border px-2 py-1 align-top">${r.to || ""}</td>
        <td class="border px-2 py-1 align-top">${r.when || ""}</td>
        <td class="border px-2 py-1 align-top">${r.who || ""}</td>
        <td class="border px-2 py-1 align-top">${r.how || ""}</td>
      </tr>`;

        // ‚îÄ‚îÄ Professional Investigation Analysis ( 3W1H ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Guaranteed different from raw data via client-side expansion
        let prob = (r.problem || "").trim();
        let plan = (r.actionPlan || "").trim();
        const fromVal = (r.fromNumeric || r.from || "N/A");
        const toVal = (r.toNumeric || r.to || "N/A");

        // Expand problem ONLY if missing / same as what / too short
        const rawWhat = (r.what || "").trim().replace(/\.*$/, "");
        if (!prob || prob === rawWhat || prob.length < 30) {
          // Lowercase the first char to blend with "that"
          const cleanWhat = rawWhat ? (rawWhat.charAt(0).toLowerCase() + rawWhat.slice(1)) : "the identified issue";
          prob = "It has been critically observed that " + cleanWhat + ", adversely affecting organization performance and necessitating urgent corrective intervention.";
        }

        // Expand actionPlan ONLY if missing / same as how / too short
        const rawHow = (r.how || "").trim().replace(/\.*$/, ""); // Remove trailing periods
        if (!plan || plan === rawHow || plan.length < 30) {
          plan = "1. Implement immediately: " + (rawHow || "corrective measures") + ". 2. Track progress via monthly KPIs to ensure sustainable outcomes.";
        }

        // Format numbered steps with line breaks
        const formattedPlan = plan.replace(/(\d+\.\s)/g, '<br>$1').replace(/^<br>/, '');

        professionalBody.innerHTML += `
      <tr>
        <td class="border px-2 py-1 align-top">${i + 1}</td>
        <td class="border px-2 py-1 align-top"><strong>${prob}</strong></td>
        <td class="border px-2 py-1 align-top">${fromVal}</td>
        <td class="border px-2 py-1 align-top">${toVal}</td>
        <td class="border px-2 py-1 align-top">${r.when || ""}</td>
        <td class="border px-2 py-1 align-top">${r.who || ""}</td>
        <td class="border px-2 py-1 align-top">${formattedPlan}</td>
      </tr>`;

        // Build executive summary text (400+ words covering What / How / From / To)
        let summaryText = (r.summary || "").trim();
        if (!summaryText || summaryText.length < 200) {
          summaryText = prob
            + " The proposed action plan to address this critical observation encompasses the following strategic measures: "
            + plan
            + " The transition from the current baseline of \"" + (r.from || "existing level")
            + "\" to the strategic target of \"" + (r.to || "desired level")
            + "\" is a key organizational priority. Successful implementation of these corrective measures is projected to yield measurable improvements in operational performance, enhance customer satisfaction, and contribute to the organization's long-term sustainable growth. All stakeholders are advised to collaborate closely and maintain clear accountability throughout the implementation process.";
        }
        summaryParts.push(summaryText);
      });

      // Render Executive Summary Box
      const summaryBox = document.getElementById('summaryBox');
      const summaryContent = document.getElementById('summaryContent');
      if (summaryParts.length > 0) {
        summaryBox.classList.remove('hidden');
        summaryContent.innerHTML = summaryParts.map((p, idx) => `
          <div class="${idx > 0 ? 'mt-4 pt-4 border-t' : ''}">
            <div class="font-bold mb-1 text-green-700">Analysis Row #${idx + 1}:</div>
            ${p}
          </div>
        `).join('');
      } else {
        summaryBox.classList.add('hidden');
      }
    }

    /* ===== CLEAR / EXPORT ===== */
    function clearOutput() {
      resultBody.innerHTML = ""; professionalBody.innerHTML = "";
      textInput.value = ""; audioFile.value = "";
      document.getElementById('summaryBox').classList.add('hidden');
      document.getElementById('summaryContent').innerHTML = '';
    }
    function exportExcel(id, name) {
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById(id)), "Report");
      XLSX.writeFile(wb, name);
    }

    function exportProfessional() {
      const wb = XLSX.utils.book_new();
      // Get Professional Analysis table as sheet
      const ws = XLSX.utils.table_to_sheet(document.getElementById('professionalTable'));

      // Find the last row of existing data
      const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
      const lastRow = range.e.r + 2; // leave one blank row

      // Add Summary header
      ws[XLSX.utils.encode_cell({ r: lastRow, c: 0 })] = { t: 's', v: 'Executive Summary' };
      // Bold style for header
      ws[XLSX.utils.encode_cell({ r: lastRow, c: 0 })].s = { font: { bold: true } };

      // Get summary text (strip HTML tags)
      const summaryEl = document.getElementById('summaryContent');
      const summaryText = summaryEl ? summaryEl.innerText : '';

      if (summaryText) {
        // Place summary in the row below the header, spanning full width
        const summaryRow = lastRow + 1;
        ws[XLSX.utils.encode_cell({ r: summaryRow, c: 0 })] = { t: 's', v: summaryText };

        // Merge cells across all columns for summary
        if (!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({
          s: { r: lastRow, c: 0 }, e: { r: lastRow, c: range.e.c }
        });
        ws['!merges'].push({
          s: { r: summaryRow, c: 0 }, e: { r: summaryRow, c: range.e.c }
        });

        // Update range to include summary rows
        ws['!ref'] = XLSX.utils.encode_range({
          s: { r: 0, c: 0 },
          e: { r: summaryRow, c: range.e.c }
        });
      }

      // Set reasonable column widths
      ws['!cols'] = [
        { wch: 4 },   // #
        { wch: 35 },  // What (Problem)
        { wch: 20 },  // From
        { wch: 20 },  // To
        { wch: 15 },  // When
        { wch: 15 },  // Who
        { wch: 35 }   // How (Action Plan)
      ];

      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      XLSX.writeFile(wb, 'Professional_Investigation_Analysis.xlsx');
    }
  </script>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    async function startSubscription(planId) {
      try {
        const apiBase = window.API_BASE_URL || "";
        const res = await fetch(apiBase + "/api/subscription/create", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken },
          body: JSON.stringify({ planId })
        });

        if (!res.ok) throw new Error("Failed to create subscription");
        const sub = await res.json();

        const options = {
          key: "rzp_test_SGIiAzizfrBnv8",
          subscription_id: sub.subscriptionId,
          name: "3W1H Smart Converter",
          description: "Subscription Plan",
          handler: async function (response) {
            // Activate the plan on the server
            try {
              const activateRes = await fetch(apiBase + "/api/subscription/activate", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken },
                body: JSON.stringify({ planId: planId, paymentId: response.razorpay_payment_id })
              });
              const activateData = await activateRes.json();
              console.log("‚úÖ Activation response:", activateData);

              if (!activateRes.ok) {
                alert("Payment received but plan activation failed. Please contact support.");
                return;
              }
            } catch (e) {
              console.error("Activate error:", e);
              alert("Payment received but activation failed. Please refresh the page.");
              return;
            }

            alert("üéâ Subscription Successful! Your plan has been upgraded.");
            closeSubscription();
            // Small delay to let Firestore write complete
            setTimeout(() => loadSubscription(), 500);
          },
          theme: { color: "#2563eb" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error(err);
        alert("Payment initialization failed.");
      }
    }

    async function loadSubscription() {
      console.log("üì° Loading subscription... authToken:", authToken ? "present" : "MISSING");
      if (!authToken) {
        console.warn("‚ö†Ô∏è Cannot load subscription: no auth token yet");
        return;
      }
      // Helper to show card with given data (always called, even on error)
      function showSubscriptionCard(planName, expiryDate, creditsVal, unlimited) {
        const cardEl = document.getElementById("subscriptionCard");
        const planEl = document.getElementById("subPlan");
        const expiryEl = document.getElementById("subExpiry");
        const creditEl = document.getElementById("creditBalance");
        if (!cardEl || !planEl) return;

        cardEl.classList.remove("hidden");
        planEl.textContent = "Current Plan: " + planName;

        if (expiryDate && expiryEl) {
          const expDate = new Date(expiryDate);
          expiryEl.textContent = expDate > new Date() ? "Valid until " + expiryDate : "Expired on " + expiryDate;
        } else if (expiryEl) {
          expiryEl.textContent = "";
        }

        if (unlimited) {
          isUnlimited = true;
          totalPlanCredits = 0;
          if (creditEl) creditEl.textContent = "Unlimited";
        } else {
          isUnlimited = false;
          credits = typeof creditsVal === "number" ? creditsVal : parseInt(creditsVal) || 0;
          if (creditEl) creditEl.textContent = credits;
          if (planName === "Free Trial") totalPlanCredits = 50;
          else if (planName === "Basic") totalPlanCredits = 500;
          else if (planName === "Pro") totalPlanCredits = 1200;
          else totalPlanCredits = credits;
        }
        console.log("‚úÖ Plan loaded:", planName, "| Credits:", unlimited ? "Unlimited" : credits);
      }

      try {
        const apiBase = window.API_BASE_URL || "";
        const res = await fetch(apiBase + "/api/subscription/status", {
          headers: { "Authorization": "Bearer " + authToken }
        });

        if (!res.ok) {
          console.error("‚ùå Subscription API error:", res.status, res.statusText);
          // Show card with Free Trial defaults so user always sees something
          showSubscriptionCard("Free Trial", null, 50, false);
          return;
        }

        const sub = await res.json();
        console.log("üìä Subscription data:", sub);

        const isUnlimitedPlan = sub.planName === "Premium" || sub.remainingCredits === "Unlimited";
        const rc = isUnlimitedPlan ? 0 : (typeof sub.remainingCredits === "number" ? sub.remainingCredits : parseInt(sub.remainingCredits) || 0);
        showSubscriptionCard(sub.planName || "Free Trial", sub.expiryDate, rc, isUnlimitedPlan);

      } catch (e) {
        console.error("‚ùå Subscription load error:", e);
        // Always show card even if network fails
        showSubscriptionCard("Free Trial", null, 50, false);
      }
    }

  </script>

  <!-- API Config (loaded first so API_BASE_URL is available everywhere) -->
  <script src="/config.js"></script>

  <!-- Firebase Authentication -->
  <script src="/firebase-config.js"></script>
  <script>
    // Global variable to store current user
    let currentUser = null;
    let authToken = null;

    // Check authentication on page load
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not logged in, redirect to login
        window.location.href = '/login.html';
        return;
      }

      currentUser = user;

      // Check email verification
      if (!user.emailVerified) {
        // Show verification reminder
        showEmailVerificationReminder();
        return;
      }

      // Get ID token for API calls
      authToken = await user.getIdToken();

      // Display user email
      document.getElementById('userEmail').textContent = user.email;

      // Show guidance note on every login
      showGuidanceModal();

      // Load user's subscription
      loadSubscription();
    });

    // Email verification reminder
    function showEmailVerificationReminder() {
      const reminderHTML = `
        <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center">
          <div class="bg-white rounded-lg shadow-xl p-8 max-w-md mx-4">
            <div class="text-center">
              <div class="text-6xl mb-4">üìß</div>
              <h2 class="text-2xl font-bold text-gray-800 mb-3">Verify Your Email</h2>
              <p class="text-gray-600 mb-6">
                Please verify your email address to access the dashboard. 
                We've sent a verification link to <strong>${currentUser.email}</strong>
              </p>
              <div class="space-y-3">
                <button onclick="resendVerificationEmail()" 
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">
                  Resend Verification Email
                </button>
                <button onclick="checkEmailVerified()" 
                  class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition">
                  I've Verified - Continue
                </button>
                <button onclick="handleLogout()" 
                  class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition">
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', reminderHTML);
    }

    // Resend verification email
    async function resendVerificationEmail() {
      try {
        await currentUser.sendEmailVerification();
        alert('Verification email sent! Please check your inbox.');
      } catch (error) {
        console.error('Resend error:', error);
        alert('Failed to send email: ' + error.message);
      }
    }

    // Check if email is now verified
    async function checkEmailVerified() {
      try {
        await currentUser.reload();
        if (currentUser.emailVerified) {
          window.location.reload();
        } else {
          alert('Email not yet verified. Please check your inbox and click the verification link.');
        }
      } catch (error) {
        console.error('Verification check error:', error);
        alert('Error checking verification status: ' + error.message);
      }
    }

    // Logout function
    async function handleLogout() {
      try {
        await auth.signOut();
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to logout: ' + error.message);
      }
    }



    // Override fetch to include authentication token
    const originalFetch = window.fetch;
    window.fetch = async function (url, options = {}) {
      // Handle relative API paths
      if (url.startsWith('/api/')) {
        url = (window.API_BASE_URL || '') + url;
      }

      // Add auth header for API calls (both relative and absolute)
      if (url.includes('/api/')) {
        const token = await getIdToken();
        if (token) {
          options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
          };
        }
      }
      return originalFetch(url, options);
    };
  </script>

</body>

</html>